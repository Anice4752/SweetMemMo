<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ติดตามสถานะออเดอร์ - Sweet Memories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #fdfaf6; }
        .step { flex: 1; }
        .step-line { position: absolute; top: 1.125rem; left: 50%; right: -50%; height: 2px; background-color: #e5e7eb; }
        .step.active .step-circle { background-color: #16a34a; border-color: #16a34a; color: white; }
        .step.active .step-title { color: #15803d; }
        .step.active .step-line { background-color: #16a34a; }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-8 max-w-2xl mt-10">
        <header class="text-center mb-8">
            <a href="index.html" class="text-2xl font-bold text-amber-800">ขนมหวานใจไทย</a>
            <h1 class="text-3xl font-bold text-gray-700 mt-2">ติดตามสถานะออเดอร์</h1>
            <p class="text-gray-500">กรอกหมายเลขออเดอร์ 6 หลักของคุณเพื่อตรวจสอบสถานะล่าสุด</p>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex gap-2">
                <input type="text" id="order-id-input" placeholder="กรอกหมายเลขออเดอร์ 6 หลักที่นี่" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" maxlength="6">
                <button onclick="trackOrder()" class="bg-amber-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-amber-700 transition">ค้นหา</button>
            </div>
        </div>

        <main id="result-container" class="mt-8 hidden"></main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, limit, documentId } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG (FOR LIVE DEPLOYMENT) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBhX2XydeULLIDHo8IQJTuj1y4WLN_v-Qo",
            authDomain: "sweetmemmo-e475d.firebaseapp.com",
            projectId: "sweetmemmo-e475d",
            storageBucket: "sweetmemmo-e475d.firebasestorage.app",
            messagingSenderId: "968961976245",
            appId: "1:968961976245:web:a38dd1892a37842cf75bfc",
            measurementId: "G-9D81RYHSEG"
        };
        const appId = "sweetmemmo-e475d";
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase initialization failed:", e); }

        const resultContainer = document.getElementById('result-container');
        const orderInput = document.getElementById('order-id-input');

        const STATUS_STEPS = ['paid', 'preparing', 'ready', 'completed'];
        const STATUS_MAP = {
            paid: 'ชำระเงินแล้ว',
            preparing: 'กำลังเตรียม',
            ready: 'พร้อมรับ',
            completed: 'รับของแล้ว',
            cancelled: 'ยกเลิก'
        };

        function renderStatusTracker(currentStatus) {
            if (currentStatus === 'cancelled') {
                return `<div class="text-center p-4 bg-red-100 text-red-700 rounded-lg">
                    <h3 class="font-bold text-xl">ออเดอร์นี้ถูกยกเลิกแล้ว</h3>
                </div>`;
            }
            const currentIndex = STATUS_STEPS.indexOf(currentStatus);
            let stepsHTML = STATUS_STEPS.map((step, index) => {
                const isActive = index <= currentIndex;
                return `
                    <div class="step relative text-center ${isActive ? 'active' : ''}">
                        ${index > 0 ? '<div class="step-line"></div>' : ''}
                        <div class="step-circle relative z-10 mx-auto w-9 h-9 flex items-center justify-center rounded-full border-2 border-gray-300 bg-white font-bold">${index + 1}</div>
                        <p class="step-title mt-2 font-semibold text-gray-500 text-sm md:text-base">${STATUS_MAP[step]}</p>
                    </div>
                `;
            }).join('');
            return `<div class="flex">${stepsHTML}</div>`;
        }

        window.trackOrder = async function() {
            const searchId = orderInput.value.trim();
            if (searchId.length !== 6 || !db) {
                resultContainer.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-center text-red-500">กรุณากรอกหมายเลขออเดอร์ 6 หลักให้ถูกต้อง</p></div>';
                resultContainer.classList.remove('hidden');
                return;
            }
            resultContainer.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-center text-gray-500">กำลังค้นหา...</p></div>';
            resultContainer.classList.remove('hidden');

            try {
                const endId = searchId + '\uf8ff';
                const q = query(
                    collection(db, `artifacts/${appId}/public/data/pre-orders`),
                    where(documentId(), '>=', searchId),
                    where(documentId(), '<=', endId),
                    limit(1)
                );

                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const docSnap = querySnapshot.docs[0];
                    const order = { id: docSnap.id, ...docSnap.data() };
                    const itemsHTML = order.items.map(item => `
                        <li class="p-3 flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-500">จำนวน: ${item.quantity}</p>
                            </div>
                            <p class="font-semibold text-gray-700">฿${(item.price * item.quantity).toFixed(2)}</p>
                        </li>
                    `).join('');

                    resultContainer.innerHTML = `
                        <div class="bg-white border border-gray-200 rounded-lg shadow-md overflow-hidden">
                            <!-- Header -->
                            <div class="bg-gray-50 p-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-2">
                                <div>
                                    <p class="text-sm text-gray-500">หมายเลขออเดอร์</p>
                                    <h2 class="text-2xl font-bold text-amber-800 tracking-widest">${order.id.substring(0,6)}</h2>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">สำหรับคุณ</p>
                                    <p class="font-semibold text-lg text-gray-800">${order.customerName}</p>
                                </div>
                            </div>

                            <!-- Status Tracker -->
                            <div class="p-6">
                                <h3 class="font-bold text-lg mb-6 text-center text-gray-700">สถานะปัจจุบัน</h3>
                                ${renderStatusTracker(order.status)}
                            </div>

                            <!-- Details and Items -->
                            <div class="bg-gray-50 p-6 border-t border-gray-200">
                                <div class="mb-4">
                                    <p class="font-semibold text-gray-700">วันที่นัดรับ:</p>
                                    <p class="text-indigo-600 font-bold text-lg">${new Date(order.pickupDate).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</p>
                                </div>
                                
                                <h3 class="font-bold text-lg mb-2 text-gray-700">สรุปรายการ</h3>
                                <div class="border border-gray-200 rounded-md bg-white">
                                    <ul class="divide-y divide-gray-200">
                                        ${itemsHTML}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultContainer.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-center text-red-500 font-bold">ไม่พบข้อมูลออเดอร์นี้</p></div>';
                }
            } catch (error) {
                console.error("Error fetching order:", error);
                resultContainer.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-center text-red-500 font-bold">เกิดข้อผิดพลาดในการค้นหา</p></div>';
            }
        }
    </script>
</body>
</html>


